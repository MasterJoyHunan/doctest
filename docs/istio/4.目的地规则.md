配置项手册：https://istio.io/latest/docs/reference/config/networking/destination-rule/

### 目的地规则 DestinationRule

路由发生后应用于用于服务的流量的策略。这些规则指定负载平衡的配置、sidecar 的连接池大小以及异常值检测设置，以检测并从负载平衡池中驱逐不健康的主机

### 典型 DestinationRule

```yaml
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: bookinfo-ratings
spec:
  host: ratings # 选择那个服务, 跨命名空间得使用全限定域名
  subsets: # 子集定义
  - name: v3 # 子集的名字，用于虚拟服务 VirtualService 中的 route.destination.subset 
    labels: # 标签选择器
      version: v3.0.0  # 在使用 ratings 服务下，筛选 pod label 含有 version: v3.0.0 的 pod
```

### trafficPolicy 流量治理

设置所有子集的 trafficPolicy

```yaml
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: bookinfo-ratings
spec:
  host: ratings
  trafficPolicy:
    loadBalancer:
      simple: ROUND_ROBIN
  subsets: 
  - name: v3 
    labels: 
      version: v3.0.0 
```

每个子集分别设置 trafficPolicy，

```yaml
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: bookinfo-ratings
spec:
  host: ratings
  trafficPolicy:
    loadBalancer:
      simple: ROUND_ROBIN
  subsets: 
  - name: v3 
    labels: 
      version: v3.0.0 
    trafficPolicy:
      loadBalancer:
        simple: ROUND_ROBIN
      ......
```

#### loadBalancer 负载均衡

##### 简单负载均衡

```yaml
trafficPolicy:
  loadBalancer:
    simple: LEAST_REQUEST # 负载均衡算法
```

* RANDOM -- 随机
* PASSTHROUGH -- 由客户端选择
* ROUND_ROBIN -- 循环负载平衡
* LEAST_REQUEST -- 请求最少 （官方推荐）
* LEAST_CONN -- 已弃用

##### 一致性 hash 负载均衡

```yaml
trafficPolicy:
  loadBalancer:
    consistentHash:
      httpCookie:
        name: user
        ttl: 0s
```

可配置项：httpHeaderName、httpCookie、useSourceIp、httpQueryParameterName、ringHash、maglev、minimumRingSize

#### connectionPool 连接池设置

常用于服务的熔断，配合 outlierDetection 使用

```yaml
trafficPolicy:
  connectionPool:
    http:
      http1MaxPendingRequests: 5 # 等待就绪连接池连接时排队的最大请求数
      maxRequestsPerConnection: 3 # 每个连接的最大请求数
    tcp:
      maxConnections: 10 # 到目标主机的最大连接数
```

这里配置的意思是：可以允许 10 个连接，每个连接最多能发送3个请求，并且可以等待 5个连接

#### outlierDetection 驱逐策略

一个断路器实现，常用于服务的熔断

```yaml
trafficPolicy:
  outlierDetection:
    interval: 10s # 间隔时间扫描 pod 出现 5xx 的次数
    consecutive5xxErrors: 7 # pod 出现 5xx 的次数
    baseEjectionTime: 10s # 被驱逐的时间
    maxEjectionPercent: 100 # 最多可驱逐 pod 的比例
```

#### tls 客户端TLS设置

手动提供 tls 设置

```yaml
trafficPolicy:
  tls:
    mode: MUTUAL
    clientCertificate: /etc/certs/myclientcert.pem
    privateKey: /etc/certs/client_private_key.pem
    caCertificates: /etc/certs/rootcacerts.pem
```

使用上游的 tls

```yaml
trafficPolicy:
  tls:
    mode: SIMPLE
```

自动 tls 

```yaml
trafficPolicy:
  tls:
    mode: ISTIO_MUTUAL
```

