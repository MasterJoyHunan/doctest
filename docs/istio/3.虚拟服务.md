配置项手册：https://istio.io/latest/docs/reference/config/networking/virtual-service/

### 虚拟服务 VirtualService

影响流量路由的配置

### 典型 VirtualService

```yaml
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: third-party-api
  namespace: dev
spec:
  gateways:
    - apiv2-masterjoy-top # 选择网关,如果网关定义在不同的 namespace 下，前面需要加上命名空间
  hosts:
    - apiv2.masterjoy.top # 选择网关内的域名
  http:
    - route: # 路由选择
        - destination:
            host: third-party-api # 选择对应的 svc, 如果在不同的 namespace 下，需要修改为全限定域名。如：third-party-api.prod.svc.cluster.local
            subset: v172 # 选择 DestinationRule 对应的子集
```

### http 路由选择

#### match 对路由进行匹配

##### 对 uri 进行前缀匹配

```yaml
- match:
    uri: # 对 uri 进行匹配 
      prefix: /foo # 前缀
```

##### 对 uri 进行完全匹配

```yaml
- match:
    uri: 
      exact: /foo 
```

##### 对 uri 进行正则匹配

正则规则：https://github.com/google/re2/wiki/

```yaml
- match:
    uri: 
      regex: /foo/\d+
```

可以对 scheme、method、authority、headers、port、queryParams 常规的域名访问进行匹配

也可以对微服务之间访问使用 sourceLabels、sourceNamespace 进行匹配

#### route 路由

destination -- 路由目的地，可以设置多个

```yaml
- route:
  - destination:
      host: reviews # svc 选择，不同的命名空间下使用全限定域名
      subset: v2 # 关联目的地规则对应的子集
```

weight -- 目的地权重，如果有多个目的地，并且没有设置权重的话，则每个目的地的权重均等，如果设置了，则根据权重分配流量。**所有的权重相加必须为100**

```yaml
- route:
  - destination:
      host: reviews
      subset: v1 
    weight: 30 # 30% 的流量到目的地 v1 子集
  - destination:
      host: reviews
      subset: v2 
    weight: 30 # 30% 的流量到目的地 v2 子集
  - destination:
      host: reviews
      subset: v3 
    weight: 40 # 40% 的流量到目的地 v3 子集
```

此外还可以设置 port

#### redirect 对匹配的路由进行请求转发

```yaml
redirect:
  authority: www.baidu.com # 服务名或域名
  uri: /v1/bookRatings # 重定向的地址
```

此外还可以设置 port、derivePort、scheme、redirectCode

#### rewrite 请求重写

```yaml
rewrite:
  uri: /v1/bookRatings # 使用该值重写 URI 的路径（或前缀）部分。如果原始 URI 根据前缀进行匹配，则此字段中提供的值将替换相应的匹配前缀。
```

复杂重写则需要配置 uriRegexRewrite ：https://istio.io/latest/docs/reference/config/networking/virtual-service/#RegexRewrite

#### timeout 超时设置

设置超时时间，如果超过对应的时间没有响应，则 istio 会返回 504 错误

```yaml
timeout: 10s # 可设置的时间单位 1h/1m/1s/1ms
```

#### retries 重试

```yaml
retries:
  attempts: 3 # 允许的最大重试次数，重试之间的间隔将自动确定（25ms+）
  perTryTimeout: 2s # 重试超时时间
  retryOn: connect-failure,refused-stream,503 # 指定重试发生的条件 
```

重试策略可选项：https://www.envoyproxy.io/docs/envoy/latest/configuration/http/http_filters/router_filter#x-envoy-retry-on

#### fault 错误注入

用于模拟服务之间调用时的延迟，异常

* delay 延迟注入

```yaml
fault:
  delay:
    percentage:
      value: 0.1 # 请求服务延迟的百分比 -- 0.1%
    fixedDelay: 5s # 延迟时间设置 -- 5秒
```

* abort 异常注入

```yaml
fault:
  abort:
    percentage: 
      value: 0.1  # 请求服务异常百分比 -- 0.1%
    httpStatus: 400 # 服务返回状态码
```

#### mirror 流量镜像，影子测试

想象一个场景，你对一个项目或一些接口进行了重构，为了测试重构后的项目能完全能替换老版本，你可以将现有指向老项目的流量镜像一份，用于测试重构后的项目，等确定完全没问题之后，你再上线重构的项目

```yaml
mirror:
  host: reviews # 服务
  subset: v2 # 目的地子集
mirrorPercentage:
  value: 100 # 镜像的流量的百分比，如果缺少此字段，则将镜像所有流量 (100%)
```

#### mirrors 多个流量镜像

```yaml
mirrors:
  - destination:
      host: reviews # 服务
      subset: v2 # 目的地子集
    percentage:
      value: 100 # 镜像的流量的百分比，如果缺少此字段，则将镜像所有流量 (100%)
```

#### cors 策略

这个就不解析了，一看就懂。一般在代码里面就配置好了跨域

```yaml
corsPolicy:
  allowOrigins:
  - exact: https://example.com
  allowMethods:
  - POST
  - GET
  allowCredentials: false
  allowHeaders:
  - X-Foo-Bar
  maxAge: "24h"
```

