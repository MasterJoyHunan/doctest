### 没有深入研究

配置项手册：https://istio.io/latest/docs/reference/config/networking/destination-rule/

### EnvoyFilter 

EnvoyFilter提供了一种自定义 Istio Pilot 生成的 Envoy 配置的机制。使用 EnvoyFilter 修改某些字段的值、添加特定过滤器，甚至添加全新的侦听器、集群等。必须谨慎使用此功能，因为不正确的配置可能会破坏整个网格的稳定性。与其他 Istio 网络对象不同，EnvoyFilter 是附加应用的。对于特定命名空间中的给定工作负载，可以存在任意数量的 EnvoyFilter。这些 EnvoyFilter 的应用顺序如下：配置根命名空间中的所有 EnvoyFilter ，然后是工作负载命名空间中的所有匹配的 EnvoyFilter。

EnvoyFilter 示例：

```yaml
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: filter-local-ratelimit-svc
  #namespace: istio-system
spec:
  workloadSelector:
    labels:
      app: nginx
  configPatches:
    - applyTo: HTTP_FILTER
      match:
        context: SIDECAR_INBOUND
        listener:
          filterChain:
            filter:
              name: "envoy.filters.network.http_connection_manager"
      patch:
        operation: INSERT_BEFORE
        value:
          name: envoy.filters.http.local_ratelimit
          typed_config:
            "@type": type.googleapis.com/udpa.type.v1.TypedStruct
            type_url: type.googleapis.com/envoy.extensions.filters.http.local_ratelimit.v3.LocalRateLimit
            value:
              stat_prefix: http_local_rate_limiter
    - applyTo: HTTP_ROUTE
      match:
        context: SIDECAR_INBOUND
        routeConfiguration:
          vhost:
            name: "inbound|http|80"
            route:
              action: ANY
      patch:
        operation: MERGE
        value:
          typed_per_filter_config:
            envoy.filters.http.local_ratelimit:
              "@type": type.googleapis.com/udpa.type.v1.TypedStruct
              type_url: type.googleapis.com/envoy.extensions.filters.http.local_ratelimit.v3.LocalRateLimit
              value:
                stat_prefix: http_local_rate_limiter
                token_bucket:
                  max_tokens: 1
                  tokens_per_fill: 1
                  fill_interval: 60s
                filter_enabled:
                  runtime_key: local_rate_limit_enabled
                  default_value:
                    numerator: 100
                    denominator: HUNDRED
                filter_enforced:
                  runtime_key: local_rate_limit_enforced
                  default_value:
                    numerator: 100
                    denominator: HUNDRED
                response_headers_to_add:
                  - append: false
                    header:
                      key: x-local-rate-limit
                      value: 'true'
```



### workloadSelector 工作空间选择器

用于选择应应用此补丁配置的特定 Pod/VM 集的标准。如果省略，此配置中的补丁集将应用于同一命名空间中的所有工作负载实例。如果`EnvoyFilter`存在于配置根命名空间中，它将应用于任何命名空间中的所有适用工作负载。

```yaml
workloadSelector:
  labels: # 标签搜索的范围仅限于资源所在的配置命名空间。
    app: nginx
```

### configPatches

具有匹配条件的一个或多个补丁

#### applyTo

```yaml
configPatches:
- applyTo: HTTP_FILTER # 指定应在 Envoy 配置中的何处应用给定补丁。
  match: # 匹配侦听器/路由配置/集群。
  	context: ANY # 要匹配的特定配置生成上下文
  	listener: 
    routeConfiguration:
    cluster:
```



#### match

#### patch

### priority

优先级定义了补丁集在上下文中应用的顺序。当一个补丁依赖于另一个补丁时，补丁应用的顺序很重要。API 提供了两种主要的补丁订购方式。根命名空间中的补丁集先于工作负载命名空间中的补丁集应用。补丁集中的补丁按照它们在`configPatches`列表中出现的顺序进行处理。

优先级的默认值为 0，范围为 [ min-int32, max-int32 ]。优先级为负的补丁集会在默认优先级之前处理。优先级为正的补丁集将在默认值之后进行处理。

建议从 10 的倍数的优先级值开始，以便为进一步插入留出空间。

补丁集按以下升序键顺序排序：优先级、创建时间、完全限定资源名称。



限流是一种预防措施，在发生灾难发生前就对并发访问进行限制

### 全局速率限制

### 本地速率限制

支持 L4 连接的本地（非分布式）速率限制 。区别在于本地速率限制侦听器过滤器 <config_listener_filters_local_rate_limit>在 TLS 握手和过滤器链匹配之前处理套接字。

Envoy 另外还支持通过 HTTP 本地速率限制 [过滤器对 HTTP 请求进行本地速率限制](https://www.envoyproxy.io/docs/envoy/latest/configuration/http/http_filters/local_rate_limit_filter#config-http-filters-local-rate-limit)。这可以在侦听器级别或更具体的级别（例如：虚拟主机或路由级别）全局激活。

最后，Envoy 还支持[全局速率限制](https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/other_features/global_rate_limiting#arch-overview-global-rate-limit)。本地速率限制可以与全局速率限制结合使用，以减少全局速率限制服务的负载。

```yaml
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: filter-local-ratelimit-svc
  namespace: istio-system
spec:
  workloadSelector:
    labels:
      app: productpage
  configPatches:
    - applyTo: HTTP_FILTER
      match:
        context: SIDECAR_INBOUND
        listener:
          filterChain:
            filter:
              name: "envoy.filters.network.http_connection_manager"
      patch:
        operation: INSERT_BEFORE
        value:
          name: envoy.filters.http.local_ratelimit
          typed_config:
            "@type": type.googleapis.com/udpa.type.v1.TypedStruct
            type_url: type.googleapis.com/envoy.extensions.filters.http.local_ratelimit.v3.LocalRateLimit
            value:
              stat_prefix: http_local_rate_limiter
              token_bucket:
                max_tokens: 10
                tokens_per_fill: 10
                fill_interval: 60s
              filter_enabled:
                runtime_key: local_rate_limit_enabled
                default_value:
                  numerator: 100
                  denominator: HUNDRED
              filter_enforced:
                runtime_key: local_rate_limit_enforced
                default_value:
                  numerator: 100
                  denominator: HUNDRED
              response_headers_to_add:
                - append: false
                  header:
                    key: x-local-rate-limit
                    value: 'true'
```

