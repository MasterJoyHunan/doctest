文档地址：https://kubernetes.io/zh-cn/docs/concepts/workloads/controllers/deployment/

#### 使用 replicationController 手动升级

1. 修改 template 模板将 image 版本 v1 修改为 v2
2. rc 删除所有 v1 版本的 pod
3. rc 创建 v2 版本的 pod

在执行 2~3 步骤直接，可能会造成服务的短暂不可用，如果能接受，这将是最简单的升级方式

#### 使用 replicationController 滚动升级

这是一种过时的方式，因为这个过程是由 kubectl 客户端请求 k8s api 完成的，如果 kubectl 客户端升级时网络请求中断，会使升级过程就会被中断。

1. 首先创建一个 rc

```yaml
apiVersion: v1
kind: ReplicationController
metadata:
  name: shttp-rc-v1
spec:
  replicas: 3 # 指定副本数  
  template:
    spec:
      containers:
        - name: shttp
          image: w4762061/shttp:v1
```

2. 执行 `rolling-update` 操作

```shell
#                      rc 的名字    新rc名字             新镜像
kubectl rolling-update shttp-rc-vl shttp-rc-v2 --image=w4762061/shttp:v2                        
```

### Deployment

用于声明式升级应用。用于解决 rc，rs 滚动升级时，协调多个 controller 彼此之前不断修改。

Deployment 将会创建 replicaSet ，replicaSet 才会创建 pod，Deployment 是管理 rs 的资源

使用 Deployment 可以更容易地更新应用程序，因为可以直接定义单个Deployment 资源即可升级你的 pod，升级过程由 kubernetes 处理中间状态，而不是由客户端处理，避免客户端网络中断的导致升级中断的问题

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: shttp-dp
spec:
  replicas: 2 # 需要 2 个副本
  template:
    metadata:
      name: simple-po
      labels:
        beloneApp: testApp
    spec:
      containers:
        - name: shttp
          image: w4762061/shttp:v1
```

#### Deployment  查看升级状态

```sh
kubectl rollout status deployment shttp-dp
```

#### Deployment  回滚至上一个版本

```sh
kubectl rollout undo deployment shttp-dp
```

#### Deployment  暂停升级

```sh
kubectl rollout pause deployment shttp-dp
```

#### Deployment  恢复升级

```sh
kubectl rollout resume deployment shttp-dp
```



#### Deployment 速率控制

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: shttp-dp
spec:
  replicas: 3
  minReadySeconds: 10 # 新 POD 至少要成功运行多久之后才会升级下一个 POD
  strategy: # 升级策略
    rollingUpdate:
      maxSurge: 1 # 最多允许多出几个 POD
      maxUnavailable: 0  # 最多允许几个 POD 不可用
    type: RollingUpdate #滚动升级方式。 也可以设置为 Recreate，该策略会一次性删除所有老的 pod ,然后再一次性创建新的 pod
  template:
    metadata:
      name: simple-po
      labels:
        beloneApp: testApp
    spec:
      containers:
        - name: shttp
          image: w4762061/shttp:v3 # 直接修改 image 升级
```
