### 节点污点与污点容忍度

文档地址：https://kubernetes.io/zh-cn/docs/concepts/scheduling-eviction/taint-and-toleration/

节点污点：用于阻止 pod 往该节点上进行调度

pod 污点容忍度：pod 如果可以容忍某些污点，则可以调度到某些含有污点的节点上

优势在于不用修改 pod，就可以阻止 pod 往该节点上调度

#### 查看节点的污点 Taints

```sh
> kubectl describe nodes
Name:               k8s-master
......
Taints:             node-role.kubernetes.io/master:NoSchedule # 污点信息
                    # 格式为 key=value:effect, 这里的
                    # key => node-role.kubernetes.io/master
                    # value => null
                    # effect => NoSchedule
```

#### 为节点添加污点

```sh
kubectl taint nodes node1 key1=value1:NoSchedule
```

effect 有3个选项，对已部署在该节点上的 pod，如果 pod 不能容忍该污点

* NoExecute -- 会被马上驱逐
* NoSchedule -- **不会**马上驱逐
* PreferNoSchedule -- 会被**尝试**驱逐

#### 为节点删除污点

```sh
kubectl taint nodes node1 key1=value1:NoSchedule-
```

#### 查看 pod 的污点容忍 Tolerations

```sh
> k describe pod -n kube-system kube-proxy-9qkd8
Name:                 kube-proxy-9qkd8
......
Tolerations:                 op=Exists # key 为空，op=Exists，表示可以容忍任何 key, value, effect
                             node.kubernetes.io/disk-pressure:NoSchedule op=Exists # op 如果是 Exists ，只需要指定 key， op
                             node.kubernetes.io/memory-pressure:NoSchedule op=Exists
                             node.kubernetes.io/network-unavailable:NoSchedule op=Exists
                             node.kubernetes.io/not-ready:NoExecute op=Exists
                             node.kubernetes.io/pid-pressure:NoSchedule op=Exists
                             node.kubernetes.io/unreachable:NoExecute op=Exists
                             node.kubernetes.io/unschedulable:NoSchedule op=Exists
```

多个 Tolerations，就像一个过滤器，过滤掉无法容忍的节点，剩下就是可以容忍的节点

### 节点，POD 亲缘性

文档地址：https://kubernetes.io/zh-cn/docs/concepts/scheduling-eviction/assign-pod-node/#affinity-and-anti-affinity

`nodeSelector` 提供了一种最简单的方法来将 Pod 约束到具有特定标签的节点上。 亲和性和反亲和性扩展了你可以定义的约束类型

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: test-affinity
spec:
  affinity:
    nodeAffinity:
      requiredDuringSchedulingIgnoredDuringExecution: # 必须调度至包含标签 ssd=true 的节点 -- 不影响已经调度的 POD
        nodeSelectorTerms:
          - matchExpressions:
              - key: ssd
                operator: In
                values:
                  - "true"

      preferredDuringSchedulingIgnoredDuringExecution: # 节点优先级，非强制
        - weight: 80
          preference:
            matchExpressions:
              - key: ssd
                operator: In
                values:
                  - "true"
        - weight: 50
          preference:
            matchExpressions:
              - key: gpu
                operator: In
                values:
                  - "true"
    podAffinity:
      requiredDuringSchedulingIgnoredDuringExecution: # 必须调度至标签 app=backend 的 POD 所在的节点
        - topologyKey: kubernetes.io/hostname
          labelSelector:
            matchLabels:
              app: backend
      preferredDuringSchedulingIgnoredDuringExecution：# 也可以使用
  containers:
    - name: xxx
      image: xxx
```

### pod 反亲缘性

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: test-affinity
spec:
  affinity:
    podAntiAffinity:
      requiredDuringSchedulingIgnoredDuringExecution: # 必须不能调度至标签 app=backend 的 POD 所在的节点
        - topologyKey: kubernetes.io/hostname
          labelSelector:
            matchLabels:
              app: backend
      preferredDuringSchedulingIgnoredDuringExecution：# 也可以使用
  containers:
    - name: xxx
      image: xxx
```

