文档地址：https://kubernetes.io/zh-cn/docs/concepts/configuration/configmap/

### ConfigMap

用来将非机密性的数据保存到键值对中

#### 通过命名行创建 config-map

```shell
# 根据文件或文件夹创建 configmap ，名字为 my-config ，默认 key 为文件名
kubectl create configmap my-config --from-file=path/to/bar

# 根据文件创建 configmap ，名字为 my-config ,并且将 key 设置为 key1
kubectl create configmap my-config --from-file=key1=/path/to/bar/file1.txt

# 根据键值对创建 configmap ，名字为 my-config 
kubectl create configmap my-config --from-literal=key1=config1 --from-literal=key2=config2
  
# 根据环境变量文件创建 configmap ，名字为 my-config 
kubectl create configmap my-config --from-env-file=path/to/foo.env --from-env-file=path/to/bar.env
```

#### 通过资源文件创建 config-map

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: shttp-config
data:
  env: dev
  mysql.root: 127.0.0.1
  mysql.port: "1122"
  hello: world
  sleep-interval: "2"
```

### 将 config-map 挂载至 pod

#### 挂载至环境变量

挂载单个环境变量

```yaml
apiVersion: v1
kind: Pod
metadata: 
  name: shttp 
spec:
  containers:
    - image: w4762061/shttp:v1
      name: shttp
      env:  
        - name: MY_ENV_KEY
          valueFrom: # 区别于 value
            configMapKeyRef: 
              optional: true # 如果没有设置 optional = true , config-map 不存在，则 pod 无法启动
              name: shttp-config # config-map 的名字
              key: sleep-interval # config-map 的key
```

挂载多个环境变量

```yaml
apiVersion: v1
kind: Pod
metadata: 
  name: shttp 
spec:
  containers:
    - image: w4762061/shttp:v1
      name: shttp
      envFrom:  
        - prefix: sleep # 前缀为 sleep 的才会被挂载
          configMapKeyRef: 
            name: shttp-config # config-map 的名字
```

挂载后作为配置文件

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: shttp 
spec:
  containers:
    - image: w4762061/shttp:v1
      name: shttp
      volumeMounts:
        - name:  shttp-config # 这种方式将所有文件挂载到某个点
          mountPath: /etc/my-config # 挂载到目录/文件
          readOnly: true # 只读模式
  volumes:
    - name: config
      configMap:
        name: shttp-config
```

挂载后作为配置文件（仅挂载特定条目）

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: shttp 
spec:
  containers:
    - image: w4762061/shttp:v1
      name: shttp
      volumeMounts:
        - name:  shttp-config
          mountPath: /etc/my-config
  volumes:
    - name: config
      configMap:
        name: shttp-config
        items: # 挂载特定条目
          - key: sleep-interval # 挂载 shttp-config 的 sleep-interval 条目
            path: sleep-interval.conf # shttp-config 的 sleep-interval 条目的值被存储在 sleep-interval.conf 文件中
```

> 以上挂载文件到某个非空目录都会隐藏该文件夹中已存在的文件
>
> 比如将文件挂载至 /etc 目录，那么 /etc 目录下所有的文件将会被隐藏，可能会导致严重后果

不隐藏文件夹其他条目

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: shttp 
spec:
  containers:
    - image: w4762061/shttp:v1
      name: shttp
      volumeMounts:
        - name:  shttp-config # 这种方式将所有文件挂载到某个点
          mountPath: /etc/my-config.conf # 必须设置为挂载到文件
          subPath: sleep-interval # 选择挂载的条目
  volumes:
    - name: config
      configMap:
        name: shttp-config
```

> 使用 ConfigMap 作为 subPath 卷挂载的容器将不会收到 ConfigMap 的更新。

挂载文件的权限

默认挂载的权限是 644，如需修改需要设置 volumes 的 defaultMode

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: shttp 
spec:
  containers:
    ...
  volumes:
    - name: config
      configMap:
        name: shttp-config
        defaultMode: "6600"
```

