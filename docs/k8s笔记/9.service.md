文档地址：https://kubernetes.io/zh-cn/docs/concepts/services-networking/service/

### Service 服务

Deployment 可以动态地创建和销毁 Pod，每个 Pod 会获得属于自己的 IP 地址，所有 pod 的 IP 地址会经常变化，不利于建立连接。而 service 服务可以为一组功能相同的 pod 提供单一不变的接入点，它的 IP 地址和端口不会改变。 客户端通过 IP 地址和端口号建立连接，这些连接会被路由到提供该服务的任意一个 pod 上，通过这种方式， 客户端不需要知道每个单独的提供服务的 pod 的地址， 这样这些 pod 就可以在集群中随时被创建或移除。

```yaml
apiVersion: v1
kind: Service
metadata:
  name: shttp-svc
spec:
  selector: # pod 标签选择
    beloneApp: testApp
  ports: # 端口定义
    - port: 8808 # 暴露出来的端口
      targetPort: 8222 # 转发到 pod 的端口
```

### 连接集群外部的服务

服务重定向至外部IP，需要手动配置 endpoint

```yaml
apiVersion: v1
kind: Service
metadata:
  name: mysql-service
spec:
  # selector: # 不需要设置 pod 选择器，因为不是 k8s 内的服务
  ports: # 端口定义
    - port: 3306 # 暴露出来的端口
---
apiVersion: v1
kind: Endpoints
metadata:
  name: mysql-service # name 必须和 service 名字完全一致
subsets:
  - addresses:
      - ip: 111.111.112.113 # 目标 ip 地址
      - ip: 111.111.112.114 
    ports:
      - port: 3306 # 目标的端口
```

### 为外部服务创建别名 type=ExternalName

ExternalName服务仅在DNS级别实施一为服务创建了简单的CNAME DNS 记录。 因此，连接到服务的客户端将直接连接到外部服务， 完全绕过服务代理。 出于这个原因，这些类型的服务甚至不会获得集群 **IP**。

```yaml
apiVersion: v1
kind: Service
metadata:
  name: mysql-service
spec:
  type: ExternalName
  externalName: xxx-xxx.mysql.rds.aliyuncs.com
```

### 将服务暴露给外部客户端

#### NodePort

服务类型设置成 NodePort 会在每个节点上打开一个端口，并将在该端口上接收到的流量重定向到基础服务。

```yaml
apiVersion: v1
kind: Service
metadata:
  name: svc-nodeport
spec:
  type: NodePort # 服务类型设置
  selector: # pod 选择器
    beloneApp: testApp
  ports:
    - port: 8333 # 服务开放的端口
      targetPort: 8222 # 转发至 pod 的端口
      nodePort: 30092 # node 节点上开放的端口
```

#### LoadBalance

在云提供商上运行的Kubernetes集群通常支持从云基础架构自动提供负载平衡器，负载均衡器拥有自己独一无二的可公开访问的 **IP** 地址， 并将所有连接重定向到服务。可以通过负载均衡器的 **IP** 地址访问服务

```yaml
apiVersion: v1
kind: Service
metadata:
  name: svc-load-banalcer
spec:
  type: LoadBalancer # 服务类型设置
  selector:
    beloneApp: testApp
  ports:
    - port: 8444 
      targetPort: 8222
```

#### Ingress （常用）

为了使 Ingress 资源正常工作，集群必须运行一个 Ingress 控制器，一般云厂商都有自己的 ingress 控制器，本地测试可以使用 nginx-ingress 控制器

相当于普通服务器的 nginx 服务

```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: default-ingress
spec:
  tls: # tls 配置
    - hosts:
        - www.foo.bar.com
      secretName: tls secret # 使用 kubectl create secret tls some-cert-name --key=/foo/xxx.key --cert=/bar/xxx.pem 创建
  rules: 
    - host: www.test.com # 将域名映射到 k8s 服务
      http:
        paths:
          - path: / # 对 www.test.com 的所有请求发送至 my-service 服务
            pathType: Prefix
            backend:
              service:
                port:
                  number: 9090
                name: my-service
```

