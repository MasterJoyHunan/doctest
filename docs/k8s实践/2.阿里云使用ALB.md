文档地址：https://help.aliyun.com/zh/slb/application-load-balancer/product-overview/what-is-alb

### Alb 负载均衡

阿里云的负载均衡有 3 种，分别为应用型负载均衡 ALB，网络型负载均衡 NLB、传统型负载均衡CLB，这里使用对 k8s 最友好的 ALB 来说明

如果不使用 ALB 负载均衡，就需要将应用的 svc 设置为 NodePort 暴露，才能被外网访问。为了避免单节点故障用，还需要对所有暴露 NodePort 的节点进行高可用配置 （keepalive + haproxy），相对部署较为麻烦。如果使用了 ALB ，将 svc 设置为 LoadBalancer，即可暴露给外网访问。通过域名 CNAME 解析到对应 DNS 服务器即可

 ALB 负载均衡是收费服务，负载到每台服务器的价格+公网IP+产生流量

> 前提：需要创建可以创建ALB实例的阿里云账号的AccessKey ID与AccessKey Secret

#### 1）安装 alb-ingress-controller

```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: system:load-balancer-controller
rules:
- apiGroups:
  - ""
  resources:
  - events
  verbs:
  - get
  - list
  - create
  - patch
  - update
- apiGroups:
  - ""
  resources:
  - nodes
  verbs:
  - get
  - list
  - watch
- apiGroups:
  - ""
  resources:
  - nodes/status
  verbs:
  - patch
  - update
- apiGroups:
  - ""
  resources:
  - services
  - pods
  verbs:
  - get
  - list
  - watch
  - update
  - patch
- apiGroups:
  - ""
  resources:
  - configmaps
  verbs:
  - get
  - list
  - watch
  - update
  - patch
- apiGroups:
  - ""
  resources:
  - services/status
  - pods/status
  verbs:
  - update
  - patch
- apiGroups:
  - ""
  resources:
  - serviceaccounts
  verbs:
  - create
- apiGroups:
  - ""
  resources:
  - endpoints
  verbs:
  - get
  - list
  - watch
  - create
  - patch
  - update
- apiGroups:
  - coordination.k8s.io
  resources:
  - leases
  verbs:
  - get
  - list
  - update
  - create
- apiGroups:
  - apiextensions.k8s.io
  resources:
  - customresourcedefinitions
  verbs:
  - get
  - update
  - create
  - delete
- apiGroups:
  - networking.k8s.io
  resources:
  - ingresses
  - ingressclasses
  verbs:
  - get
  - list
  - watch
  - update
  - create
  - patch
  - delete
- apiGroups:
  - alibabacloud.com
  resources:
  - albconfigs
  verbs:
  - get
  - list
  - watch
  - update
  - create
  - patch
  - delete
- apiGroups:
  - alibabacloud.com
  resources:
  - albconfigs/status
  verbs:
  - update
  - patch
- apiGroups:
  - networking.k8s.io
  resources:
  - ingresses/status
  verbs:
  - update
  - patch
- apiGroups:
  - ""
  resources:
  - namespaces/status
  - namespaces
  - services
  - secrets
  verbs:
  - get
  - list
  - watch
  - update
  - create
  - patch
  - delete
- apiGroups:
  - extensions
  - apps
  resources:
  - deployments
  verbs:
  - get
  - list
  - watch
  - update
  - create
  - patch
  - delete
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: load-balancer-controller
  namespace: kube-system
---
kind: ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: system:load-controller-manager
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: system:load-balancer-controller
subjects:
  - kind: ServiceAccount
    name: load-balancer-controller
    namespace: kube-system
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: load-balancer-config
  namespace: kube-system
data:
  cloud-config.conf: |-
    {
        "Global": {
           "AccessKeyID": "xxx", # 需要替换可以创建ALB实例的阿里云账号的 AccessKey ID
           "AccessKeySecret": "xxx" # 需要替换可以创建ALB实例的阿里云账号的 AccessKey Secret
        }
    }
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: load-balancer-controller
    tier: control-plane
  name: load-balancer-controller
  namespace: kube-system
spec:
  replicas: 1
  selector:
    matchLabels:
      app: load-balancer-controller
      tier: control-plane
  template:
    metadata:
      labels:
        app: load-balancer-controller
        tier: control-plane
    spec:
      containers:
        - command:
            - /load-balancer-controller
            - --cloud-config=/etc/kubernetes/config/cloud-config.conf
            - --controllers=ingress,service
            - --leader-elect-resource-name=alb
            - --configure-cloud-routes=false
          image: alibabacloudslb/alibaba-load-balancer-controller:v1.1.2
          imagePullPolicy: Always
          livenessProbe:
            failureThreshold: 8
            initialDelaySeconds: 15
            periodSeconds: 10
            successThreshold: 1
            tcpSocket:
              port: 10258
            timeoutSeconds: 15
          name: load-balancer-controller
          readinessProbe:
            failureThreshold: 8
            initialDelaySeconds: 15
            periodSeconds: 10
            successThreshold: 1
            tcpSocket:
              port: 10258
            timeoutSeconds: 15
          resources:
            limits:
              cpu: "1"
              memory: 1Gi
            requests:
              cpu: 100m
              memory: 200Mi
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            runAsNonRoot: true
            runAsUser: 1200
          terminationMessagePath: /dev/termination-log
          terminationMessagePolicy: File
          volumeMounts:
            - mountPath: /etc/kubernetes/config
              name: cloud-config
      dnsPolicy: ClusterFirst
      imagePullSecrets:
      - name: aliyun-secret
      restartPolicy: Always
      schedulerName: default-scheduler
      securityContext: {}
      serviceAccount: load-balancer-controller
      serviceAccountName: load-balancer-controller
      terminationGracePeriodSeconds: 30
      tolerations:
        - operator: Exists
      volumes:
        - configMap:
            defaultMode: 420
            items:
              - key: cloud-config.conf
                path: cloud-config.conf
            name: load-balancer-config
          name: cloud-config
```

#### 2）创建AlbConfig及IngressClass资源

```yaml
apiVersion: alibabacloud.com/v1
kind: AlbConfig 
metadata:
  name: alb-config # 在下面用的到
spec:
  config:
    name: alb-config           # 自定义 alb 实例名字
    addressType: Internet      # Intranet表示私网，Internet表示公网 。
    zoneMappings:
    - vSwitchId: vsw-wz9e2usil7e5an1xi****    # ALB 需要至少两个可用区的交换机ID
    - vSwitchId: vsw-wz92lvykqj1siwvif****    
  listeners:
    - port: 80
      protocol: HTTP
---
apiVersion: networking.k8s.io/v1
kind: IngressClass
metadata:
  name: alb-ingress-class
spec:
  controller: ingress.k8s.alibabacloud/alb
  parameters:
    apiGroup: alibabacloud.com
    kind: AlbConfig
    name: alb-config   # 指定的 AlbConfig 资源
```

#### 3）创建 Ingress 资源

```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: ingress
  annotations:
    alb.ingress.kubernetes.io/listen-ports: '[{"HTTP": 80},{"HTTPS": 443}]' # 使用了 https 后 http 将不可用, 如果需要支持 http 并且 https 的话，需要设置该注解
spec:
  ingressClassName: alb-ingress-class # 对应上方的 IngressClass 资源
  rules:
   - host: '*.ingress.top' # 匹配域名，可以使用通配符
     http:
      paths:
      - path: /test01
        pathType: Prefix # 可以根据 url 进行匹配，然后转发对应的 svc
        backend:
          service: # 将匹配到的 url 转发至 
            name: test01-service
            port:
              number: 80
  tls: # 支持 https
  - hosts:
    - '*.ingress.top'
```

> 1）service 只能使用 NodePort 和 LoadBalancer，否则无法暴露出去，需要 https 服务
>
> 2）如果使用了 istio，只需要将 Ingress 的 backend 的 service 设置为 istio-ingress 即可，然后就可以愉快的使用 istio 治理服务

#### 4） 使用 istio 暴露服务

以 grafana 为例

Gateway 配置

```yaml
apiVersion: networking.istio.io/v1beta1
kind: Gateway
metadata:
  name: gateway-net
  namespace: istio-ingress
spec:
  selector:
    app: istio-ingress
  servers:
  - hosts:
    - '*.ingress.top'
    port:
      name: http
      number: 80
      protocol: HTTP
  - hosts:
    - '*.ingress.top'
    port:
      name: https
      number: 443
      protocol: HTTPS
    tls:
      credentialName: ingress.top 
      mode: SIMPLE
```

VirtualService 配置

```yaml
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: grafana
  namespace: istio-system
spec:
  gateways:
  - istio-ingress/gateway-net # 设置对应的网关，如果不在同一命名空间，则需要前面加上命名空间
  hosts:
  - grafana.ingress.top # 对应的域名
  http:
  - route:
    - destination: # 转发至 grafana svc, （不需要配置 Destinationrule 和 subset） 在不同的命名空间下，需要全限定域名
        host: grafana # svc
        port:
          number: 3000 # svc 端口，如果只有一个端口，可以不写
```

