### 日收集器 promtail

promtail 是 loki 官方推荐的日志收集器，适用于文件日志，docker 日志，k8s 日志收集

#### 使用 helm 安装

下载配置文件

`heml show values grafana/promtail --version 4.2.1 > values.yaml`

修改 values.yaml 

```yaml
config:
  lokiAddress: http://loki:3100/loki/api/v1/push # 修改为 loki 的 svc
  snippets:
    pipelineStages:
      - docker: {} # cri 修改为 docker
      - match: # 将不需要收集的 container 排除掉
          selector: '{container="istio-init"}'
          action: drop
      - match:
          selector: '{container="istio-proxy"}'
          action: drop

    scrapeConfigs: |
      # See also https://github.com/grafana/loki/blob/master/production/ksonnet/promtail/scrape_config.libsonnet for reference
      - job_name: kubernetes-pods
        pipeline_stages:
          {{- toYaml .Values.config.snippets.pipelineStages | nindent 4 }}
        kubernetes_sd_configs:
          - role: pod
            namespaces: # 仅收集特定命名空间下的日志
              names: 
                - dev 
                - prod 
                - middleware

```

安装

`heml install promtail grafana/promtail --version 4.2.1 -n istio-system -f values.yaml`

升级（更新配置文件）

`helm upgrade -f values.yaml promtail grafana/promtail --version 4.2.1 -n istio-system`

#### 坑

在收集 docker 25+ 版本（或许只有我的机器出现这样的问题），并且设置了日志切割 ，在日志切割的时候，`promtail` 会频繁的出现 `received file watcher event` 日志，并且每过一段时间就会重新收集整个文件的日志，而不是增量收集，导致日志重复收集。该问题不知道是什么引起的，但是通过修改 docker 版本能有效解决问题

```log
{"log":"level=info ts=2024-04-17T02:59:41.259886316Z caller=filetargetmanager.go:181 msg=\"received file watcher event\" name=/var/log/pods/prod_test-5b598cdb79-jjwbp_ccef5c07-36ae-43ac-bcdf-ea21c4629486/test/0.log.20240417-105941 op=CREATE\n","stream":"stderr","time":"2024-04-17T02:59:41.295760133Z"}
{"log":"level=info ts=2024-04-17T02:59:41.260144972Z caller=filetargetmanager.go:181 msg=\"received file watcher event\" name=/var/log/pods/prod_test-5b598cdb79-jjwbp_ccef5c07-36ae-43ac-bcdf-ea21c4629486/test/0.log op=CREATE\n","stream":"stderr","time":"2024-04-17T02:59:41.295775974Z"}
{"log":"level=info ts=2024-04-17T02:59:51.29574812Z caller=filetargetmanager.go:181 msg=\"received file watcher event\" name=/var/log/pods/prod_test-5b598cdb79-jjwbp_ccef5c07-36ae-43ac-bcdf-ea21c4629486/test/0.log.20240417-105951 op=CREATE\n","stream":"stderr","time":"2024-04-17T02:59:51.396104288Z"}
{"log":"level=info ts=2024-04-17T02:59:51.295982872Z caller=filetargetmanager.go:181 msg=\"received file watcher event\" name=/var/log/pods/prod_test-5b598cdb79-jjwbp_ccef5c07-36ae-43ac-bcdf-ea21c4629486/test/0.log op=CREATE\n","stream":"stderr","time":"2024-04-17T02:59:51.396123948Z"}
{"log":"level=info ts=2024-04-17T03:00:01.328293646Z caller=filetargetmanager.go:181 msg=\"received file watcher event\" name=/var/log/pods/prod_test-5b598cdb79-jjwbp_ccef5c07-36ae-43ac-bcdf-ea21c4629486/test/0.log.20240417-110001 op=CREATE\n","stream":"stderr","time":"2024-04-17T03:00:01.396147466Z"}
{"log":"ts=2024-04-17T03:00:01.32840106Z caller=log.go:168 level=info msg=\"Re-opening moved/deleted file /var/log/pods/prod_test-5b598cdb79-jjwbp_ccef5c07-36ae-43ac-bcdf-ea21c4629486/test/0.log ...\"\n","stream":"stderr","time":"2024-04-17T03:00:01.396167624Z"}
{"log":"ts=2024-04-17T03:00:01.328422914Z caller=log.go:168 level=info msg=\"Waiting for /var/log/pods/prod_test-5b598cdb79-jjwbp_ccef5c07-36ae-43ac-bcdf-ea21c4629486/test/0.log to appear...\"\n","stream":"stderr","time":"2024-04-17T03:00:01.396175052Z"}
{"log":"level=info ts=2024-04-17T03:00:01.328493916Z caller=filetargetmanager.go:181 msg=\"received file watcher event\" name=/var/log/pods/prod_test-5b598cdb79-jjwbp_ccef5c07-36ae-43ac-bcdf-ea21c4629486/test/0.log op=CREATE\n","stream":"stderr","time":"2024-04-17T03:00:01.396177091Z"}
================ 重点 tail routine: tail channel closed, stopping tailer ================
{"log":"level=info ts=2024-04-17T03:00:06.343006278Z caller=tailer.go:163 component=tailer msg=\"tail routine: tail channel closed, stopping tailer\" path=/var/log/pods/prod_test-5b598cdb79-jjwbp_ccef5c07-36ae-43ac-bcdf-ea21c4629486/test/0.log reason=\"gave up trying to reopen log file with a different handle\"\n","stream":"stderr","time":"2024-04-17T03:00:06.395394112Z"}
================ 重点 tail routine: exited ================
{"log":"level=info ts=2024-04-17T03:00:06.343035301Z caller=tailer.go:154 component=tailer msg=\"tail routine: exited\" path=/var/log/pods/prod_test-5b598cdb79-jjwbp_ccef5c07-36ae-43ac-bcdf-ea21c4629486/test/0.log\n","stream":"stderr","time":"2024-04-17T03:00:06.395423568Z"}
================ 重点 position timer: exited ================
{"log":"level=info ts=2024-04-17T03:00:06.34304436Z caller=tailer.go:118 component=tailer msg=\"position timer: exited\" path=/var/log/pods/prod_test-5b598cdb79-jjwbp_ccef5c07-36ae-43ac-bcdf-ea21c4629486/test/0.log\n","stream":"stderr","time":"2024-04-17T03:00:06.395426338Z"}
{"log":"level=info ts=2024-04-17T03:00:11.360982787Z caller=filetargetmanager.go:181 msg=\"received file watcher event\" name=/var/log/pods/prod_test-5b598cdb79-jjwbp_ccef5c07-36ae-43ac-bcdf-ea21c4629486/test/0.log.20240417-110011 op=CREATE\n","stream":"stderr","time":"2024-04-17T03:00:11.395574045Z"}
{"log":"level=info ts=2024-04-17T03:00:11.361210594Z caller=filetargetmanager.go:181 msg=\"received file watcher event\" name=/var/log/pods/prod_test-5b598cdb79-jjwbp_ccef5c07-36ae-43ac-bcdf-ea21c4629486/test/0.log op=CREATE\n","stream":"stderr","time":"2024-04-17T03:00:11.395588273Z"}
================ 重点 skipping update of position ================
{"log":"level=info ts=2024-04-17T03:00:12.400790119Z caller=tailer.go:206 component=tailer msg=\"skipping update of position for a file which does not currently exist\" path=/var/log/pods/prod_test-5b598cdb79-jjwbp_ccef5c07-36ae-43ac-bcdf-ea21c4629486/test/0.log\n","stream":"stderr","time":"2024-04-17T03:00:12.495250288Z"}
================重点 {Offset:0 Whence:0} ================
{"log":"ts=2024-04-17T03:00:12.400991293Z caller=log.go:168 level=info msg=\"Seeked /var/log/pods/prod_test-5b598cdb79-jjwbp_ccef5c07-36ae-43ac-bcdf-ea21c4629486/test/0.log - \u0026{Offset:0 Whence:0}\"\n","stream":"stderr","time":"2024-04-17T03:00:12.495278548Z"}
{"log":"level=info ts=2024-04-17T03:00:12.401018947Z caller=tailer.go:145 component=tailer msg=\"tail routine: started\" path=/var/log/pods/prod_test-5b598cdb79-jjwbp_ccef5c07-36ae-43ac-bcdf-ea21c4629486/test/0.log\n","stream":"stderr","time":"2024-04-17T03:00:12.495282628Z"}
{"log":"level=info ts=2024-04-17T03:00:21.394090559Z caller=filetargetmanager.go:181 msg=\"received file watcher event\" name=/var/log/pods/prod_test-5b598cdb79-jjwbp_ccef5c07-36ae-43ac-bcdf-ea21c4629486/test/0.log.20240417-110021 op=CREATE\n","stream":"stderr","time":"2024-04-17T03:00:21.395524724Z"}
{"log":"level=info ts=2024-04-17T03:00:21.394392336Z caller=filetargetmanager.go:181 msg=\"received file watcher event\" name=/var/log/pods/prod_test-5b598cdb79-jjwbp_ccef5c07-36ae-43ac-bcdf-ea21c4629486/test/0.log op=CREATE\n","stream":"stderr","time":"2024-04-17T03:00:21.395543631Z"}
{"log":"level=info ts=2024-04-17T03:00:31.425725757Z caller=filetargetmanager.go:181 msg=\"received file watcher event\" name=/var/log/pods/prod_test-5b598cdb79-jjwbp_ccef5c07-36ae-43ac-bcdf-ea21c4629486/test/0.log.20240417-110031 op=CREATE\n","stream":"stderr","time":"2024-04-17T03:00:31.49568108Z"}
{"log":"level=info ts=2024-04-17T03:00:31.425922637Z caller=filetargetmanager.go:181 msg=\"received file watcher event\" name=/var/log/pods/prod_test-5b598cdb79-jjwbp_ccef5c07-36ae-43ac-bcdf-ea21c4629486/test/0.log op=CREATE\n","stream":"stderr","time":"2024-04-17T03:00:31.495698121Z"}
{"log":"level=info ts=2024-04-17T03:00:41.457318731Z caller=filetargetmanager.go:181 msg=\"received file watcher event\" name=/var/log/pods/prod_test-5b598cdb79-jjwbp_ccef5c07-36ae-43ac-bcdf-ea21c4629486/test/0.log.20240417-110041 op=CREATE\n","stream":"stderr","time":"2024-04-17T03:00:41.495122968Z"}
{"log":"level=info ts=2024-04-17T03:00:41.457538696Z caller=filetargetmanager.go:181 msg=\"received file watcher event\" name=/var/log/pods/prod_test-5b598cdb79-jjwbp_ccef5c07-36ae-43ac-bcdf-ea21c4629486/test/0.log op=CREATE\n","stream":"stderr","time":"2024-04-17T03:00:41.495139633Z"}
{"log":"level=info ts=2024-04-17T03:00:51.492276947Z caller=filetargetmanager.go:181 msg=\"received file watcher event\" name=/var/log/pods/prod_test-5b598cdb79-jjwbp_ccef5c07-36ae-43ac-bcdf-ea21c4629486/test/0.log.20240417-110051 op=CREATE\n","stream":"stderr","time":"2024-04-17T03:00:51.495911629Z"}
{"log":"level=info ts=2024-04-17T03:00:51.492531031Z caller=filetargetmanager.go:181 msg=\"received file watcher event\" name=/var/log/pods/prod_test-5b598cdb79-jjwbp_ccef5c07-36ae-43ac-bcdf-ea21c4629486/test/0.log op=CREATE\n","stream":"stderr","time":"2024-04-17T03:00:51.495935097Z"}
{"log":"level=info ts=2024-04-17T03:01:01.536046855Z caller=filetargetmanager.go:181 msg=\"received file watcher event\" name=/var/log/pods/prod_test-5b598cdb79-jjwbp_ccef5c07-36ae-43ac-bcdf-ea21c4629486/test/0.log.20240417-110101 op=CREATE\n","stream":"stderr","time":"2024-04-17T03:01:01.59578044Z"}
{"log":"level=info ts=2024-04-17T03:01:01.536244643Z caller=filetargetmanager.go:181 msg=\"received file watcher event\" name=/var/log/pods/prod_test-5b598cdb79-jjwbp_ccef5c07-36ae-43ac-bcdf-ea21c4629486/test/0.log op=CREATE\n","stream":"stderr","time":"2024-04-17T03:01:01.595799009Z"}
```

使用 docker 20.10.11 版本就没这个问题

2024-05-16 还是有同样的问题，换成 fluent-bit 看能不能解决

