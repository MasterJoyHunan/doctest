文档地址：https://grafana.com/docs/loki/latest/send-data/fluentbit/

使用`promtail` 会频繁的出现 `received file watcher event` 日志，然后就不推送日志了，尝试很多办法始终没有解决该问题，尝试使用 fluent-bit 是否能避免出现该问题

### 安装 fluent-bit 源

```
helm repo add fluent https://fluent.github.io/helm-charts
helm repo update
```

### 下载配置文件

```
heml show values fluent/fluent-bit > values.yaml
```

### 修改配置文件

```yaml
image:
  repository: grafana/fluent-bit-plugin-loki
  tag: main-e2ed1c0 
testFramework:
  enabled: false
env:
  - name: FLUENT_LOKI_URL
    value: http://loki:3100/loki/api/v1/push 
config:
  service: |
    [SERVICE]
        Daemon Off
        Flush {{ .Values.flush }}
        Log_Level {{ .Values.logLevel }}
        Parsers_File /fluent-bit/etc/parsers.conf
        Parsers_File /fluent-bit/etc/conf/custom_parsers.conf
        HTTP_Server On
        HTTP_Listen 0.0.0.0
        HTTP_Port {{ .Values.metricsPort }}
        Health_Check On

  ## https://docs.fluentbit.io/manual/pipeline/inputs
  inputs: |
    [INPUT]
        Name tail
        Path /var/log/containers/*_dev_*.log,/var/log/containers/*_prod_*.log,/var/log/containers/*_middleware_*.log  # 需要修改的地方 设置只拉取 dev,prod,middleware 命名空间下的日志
        Exclude_Path /var/log/containers/*istio-proxy*.log,/var/log/containers/*istio-init*.log # 排除 istio-proxy，istio-init 日志
        multiline.parser docker
        Tag kube.*
        Mem_Buf_Limit 5MB
        Skip_Long_Lines On

  ## https://docs.fluentbit.io/manual/pipeline/filters
  filters: |
    [FILTER]
        Name kubernetes
        Match kube.*
        Merge_Log On
        Keep_Log Off
        K8S-Logging.Parser On
        K8S-Logging.Exclude On

  ## https://docs.fluentbit.io/manual/pipeline/outputs
  outputs: |
    [Output]
        Name grafana-loki
        Match kube.*
        Url ${FLUENT_LOKI_URL}
        Labels {job="fluent-bit"}
        LabelMapPath /fluent-bit/etc/conf/label_map.json # 重命名 label
        RemoveKeys kubernetes,stream,time # 删除 key = kubernetes,stream,time 的数据
        BatchWait 1
        BatchSize 1001024
        LineFormat json
        LogLevel info
        AutoKubernetesLabels false # 要填 false，否则上面的 RemoveKeys，LabelMapPath 配置不会生效

  ## https://docs.fluentbit.io/manual/pipeline/parsers
  customParsers: |
    [PARSER]
        Name docker_no_time
        Format json
        Time_Keep Off
        Time_Key time
        Time_Format %Y-%m-%dT%H:%M:%S.%L
        
  extraFiles:
    label_map.json: | # 重命名 label 配置
      {
        "kubernetes": {
          "container_name": "container",
          "pod_name": "pod",
          "namespace_name": "namespace",
          "host": "node_name",
          "labels": {
              "app": "app",
              "version": "version"
          }
        }
      }
      
args:
  - "-e"
  - "/fluent-bit/bin/out_grafana_loki.so"
  - --workdir=/fluent-bit/etc
  - --config=/fluent-bit/etc/conf/fluent-bit.conf
```

### 安装

```
helm install fluent-bit fluent/fluent-bit -f values.yaml -n istio-system
```

### 更新

```
helm upgrade fluent-bit fluent/fluent-bit -f values.yaml -n istio-system
```