聚合提供了分组并统计数据的能力。理解聚合的最简单的方式是将其粗略地等同为SQL的GROUP BY和SQL聚合函数。在Elasticsearch中，你可以在一个响应中同时返回命中的数据和聚合结果。你可以使用简单的API同时运行查询和多个聚合并一次返回，这避免了来回的网络通信，是非常强大和高效的。

* 计算每个年龄有多少人
```json
GET bank/_search
{
    "aggs": {
        "group_by_state": {
            "terms":{
                "field": "age"
            }
        }
    }
}
```

* 只保留聚合数据
```json
GET bank/_search
{
    "size": 0, // 关键代码
    "aggs": {
        "group_by_state": {
            "terms":{
                "field": "age"
            }
        }
    }
}
```

* 在原先的聚合数据上继续聚合
```json
GET bank/_search
{
    "size": 0, 
    "aggs": {
        "group_by_state": {
            "terms":{ // 相当于 group  coutn(*)
                "field": "age"
            },
            "aggs": {
                "average_balance" : {
                    "sum": {
                        "field": "balance"
                    }
                }
            }
        },
        "total_balance": {
            "sum": { // 相当于sum(*)
                 "field": "balance"
            }
        }
    }
}
```

* 年龄分组 在分组的基础上分性别，分完性别 聚合存款
```json
GET bank/_search
{
    "size": 1, 
    "aggs": {
        "group_by_age": {
            "range": {
                "field":"age",
                "ranges": [
                    {"from": 0, "to": 20},
                    {"from": 20, "to": 30},
                    {"from": 30, "to": 40},
                    {"from": 40, "to": 50},
                    {"from": 50, "to": 100}
                ]
            },
            "aggs": {
                "group_by_sex": {
                    "terms": {
                      "field": "gender"
                    },
                    "aggs": {
                        "sum_by_gender": {
                            "sum":{
                                "field": "balance"
                            }
                        }
                    }
                  }
            }
        }
    }
}
```
```json
GET ipc_log_write/_search
{
  "size": 0,
  "aggs": {
    "group_by_carNo": {
      "terms": {
        "field": "carNo.keyword"
      }
      , "aggs": {
        "group_by_tollGateName": {
          "terms": {
            "field": "tollGateName.keyword"
          }
          , "aggs": {
            "group_by_msg": {
              "terms": {
                "field": "msg.keyword"
              }
            }
          }
        }
      }
    }
  }
}

POST _sql?format=json
{
  "query":"select carNo,tollGateName,msg, count(msg) from ipc_log_write group by carNo,tollGateName,msg"
}
```