### 生成性能数据文件

#### 通过命令行生成性能数据文件

```bash
$ go test -bench=".*" -cpuprofile cpu.profile -memprofile mem.profile
```

#### 通过代码生成性能数据文件

```go
package main

import (
  "os"
  "runtime/pprof"
)

func main() {
  cpuOut, _ := os.Create("cpu.out")
  defer cpuOut.Close()
  pprof.StartCPUProfile(cpuOut)
  defer pprof.StopCPUProfile()

  memOut, _ := os.Create("mem.out")
  defer memOut.Close()
  defer pprof.WriteHeapProfile(memOut)

  Sum(3, 5)

}

func Sum(a, b int) int {
  return a + b
}
```

#### 通过net/http/pprof生成性能数据文件

```go
import "github.com/gin-contrib/pprof"
func main() {
    route := gin.Default()
    pprof.Register(route)
}
```

获取cpu.profile

```bash
$ curl http://127.0.0.1:8080/debug/pprof/profile -o cpu.profile
```

获取 mem.profile

```bash
$ curl http://127.0.0.1:8080/debug/pprof/heap -o mem.profile
```

### 分析性能

使用go tool pprof [mem|cpu].profile命令来分析 HTTP 接口的 CPU 和内存性能。我们也可以使用命令go tool pprof

也可以使用命令go tool pprof http://127.0.0.1:8080/debug/pprof/profile，或者go tool pprof http://127.0.0.1:8080/debug/pprof/heap，来直接进入 pprof 工具的交互 Shell 中。go tool pprof会首先下载并保存 CPU 和内存性能数据文件，然后再分析这些文件。

#### 常用命令

![img](http://tc.masterjoy.top/typory/d10a2c6cbfa4e35fc4efc9a3760d1b98.jpg)

top命令，可以查看性能样本数据

```bash

(pprof) top
Showing nodes accounting for 350ms, 79.55% of 440ms total
Showing top 10 nodes out of 47
      flat  flat%   sum%        cum   cum%
     110ms 25.00% 25.00%      110ms 25.00%  runtime.futex
      70ms 15.91% 40.91%       90ms 20.45%  github.com/marmotedu/iam/internal/apiserver/store/fake.(*policies).List
      40ms  9.09% 50.00%       40ms  9.09%  runtime.epollwait
      40ms  9.09% 59.09%      180ms 40.91%  runtime.findrunnable
      30ms  6.82% 65.91%       30ms  6.82%  runtime.write1
      20ms  4.55% 70.45%       30ms  6.82%  runtime.notesleep
      10ms  2.27% 72.73%      100ms 22.73%  github.com/marmotedu/iam/internal/apiserver/service/v1.(*userService).List
      10ms  2.27% 75.00%       10ms  2.27%  runtime.checkTimers
      10ms  2.27% 77.27%       10ms  2.27%  runtime.doaddtimer
      10ms  2.27% 79.55%       10ms  2.27%  runtime.mallocgc
```

* flat：采样点落在该函数中的总时间。
* flat%：采样点落在该函数中时间的百分比。
* sum%：前面所有行的 flat% 的累加值，也就是上一项的累积百分比。
* cum：采样点落在该函数中的，以及被它调用的函数中的总时间。
* cum%：采样点落在该函数中的，以及被它调用的函数中的总次数百分比。
* 函数名。

执行top命令默认是按flat%排序的，在做性能分析时，我们需要先按照cum来排序

执行top -cum输出如下：

```bash
(pprof) top20 -cum
Showing nodes accounting for 280ms, 63.64% of 440ms total
Showing top 20 nodes out of 47
      flat  flat%   sum%        cum   cum%
         0     0%     0%      320ms 72.73%  runtime.mcall
         0     0%     0%      320ms 72.73%  runtime.park_m
         0     0%     0%      280ms 63.64%  runtime.schedule
      40ms  9.09%  9.09%      180ms 40.91%  runtime.findrunnable
     110ms 25.00% 34.09%      110ms 25.00%  runtime.futex
      10ms  2.27% 36.36%      100ms 22.73%  github.com/marmotedu/iam/internal/apiserver/service/v1.(*userService).List
         0     0% 36.36%      100ms 22.73%  github.com/marmotedu/iam/internal/apiserver/service/v1.BenchmarkListUser
         0     0% 36.36%      100ms 22.73%  runtime.futexwakeup
         0     0% 36.36%      100ms 22.73%  runtime.notewakeup
         0     0% 36.36%      100ms 22.73%  runtime.resetspinning
         0     0% 36.36%      100ms 22.73%  runtime.startm
         0     0% 36.36%      100ms 22.73%  runtime.wakep
         0     0% 36.36%      100ms 22.73%  testing.(*B).launch
         0     0% 36.36%      100ms 22.73%  testing.(*B).runN
      70ms 15.91% 52.27%       90ms 20.45%  github.com/marmotedu/iam/internal/apiserver/store/fake.(*policies).List
      10ms  2.27% 54.55%       50ms 11.36%  runtime.netpoll
      40ms  9.09% 63.64%       40ms  9.09%  runtime.epollwait
         0     0% 63.64%       40ms  9.09%  runtime.modtimer
         0     0% 63.64%       40ms  9.09%  runtime.resetForSleep
         0     0% 63.64%       40ms  9.09%  runtime.resettimer (inline)
```

#### 输出调用链路图

前提是需要安装 `Graphviz`

```bash
$ go tool pprof -svg cpu.profile > cpu.svg # svg 格式
# 网络
$ go tool pprof -svg http://localhost:8821/debug/pprof/profile > cpu.svg # svg 格式
```

#### 输出火焰图

```bash
$ go tool pprof -http="127.0.0.1:888" v1.test http://localhost:8821/debug/pprof/heap
# -http="127.0.0.1:888" 本机地址，端口不能不占用
# v1.test 随意
# http://localhost:8821/debug/pprof/heap profile文件地地址
```

