### 测试文件的命名规范

Go 的测试文件名必须以`_test.go`结尾

### 函数的命名规范.

测试用例函数必须以Test、`Benchmark`、`Example`开头，例如`TestXxx`、`BenchmarkXxx`、`ExampleXxx`，`Xxx`部分为任意字母数字的组合，首字母大写。这是由 Go 语言和 go test 工具来进行约束的，`Xxx`一般是需要测试的函数名。

### 执行`go test`命令来执行如上单元测试用例

```bash
$ go test
PASS
ok github.com/marmotedu/gopractise-demo/31/test 0.002s
```

go test 还支持下面三个参数。

-v，显示所有测试函数的运行细节：

```bash
$ go test -v
=== RUN   TestAbs
--- PASS: TestAbs (0.00s)
=== RUN   TestMax
--- PASS: TestMax (0.00s)
PASS
ok      github.com/marmotedu/gopractise-demo/31/test    0.002s
```

-run < regexp>，指定要执行的测试函数：

```bash
$ go test -v -run='TestA.*'
=== RUN   TestAbs
--- PASS: TestAbs (0.00s)
PASS
ok      github.com/marmotedu/gopractise-demo/31/test    0.001s
```

-count N，指定执行测试函数的次数：

```bash
$ go test -v -run='TestA.*' -count=2
=== RUN   TestAbs
--- PASS: TestAbs (0.00s)
=== RUN   TestAbs
--- PASS: TestAbs (0.00s)
PASS
ok      github.com/marmotedu/gopractise-demo/31/test    0.002s
```

### 使用 asset 断言 

断言包 `github.com/stretchr/testify/assert`

```go
func TestAbs_3(t *testing.T) {
    tests := []struct {
        x    float64
        want float64
    }{
        {-0.3, 0.3},
        {-2, 2},
        {-3.1, 3.1},
        {5, 5},
    }

    for _, tt := range tests {
        // Abs(tt.x) 是需要测试的方法
        assert.Equal(t, Abs(tt.x), tt.want)
    }
}
```

### 使用 `gotests` 自动生成测试代码

下载 `$ go get -u github.com/cweill/gotests/...`

gotests 命令执行格式为：gotests [options] [PATH] [FILE] ...。gotests 可以为PATH下的所有 Go 源码文件中的函数生成测试代码，也可以只为某个FILE中的函数生成测试代码。

```bash
$ gotests -all -w .
```

通过 gotests 生成测试用例

```go
func TestUnpointer(t *testing.T) {
    type args struct {
        offset *int64
        limit  *int64
    }
    tests := []struct {
        name string
        args args
        want *LimitAndOffset
    }{
        // TODO: Add test cases.
    }
    for _, tt := range tests {
        t.Run(tt.name, func(t *testing.T) {
            if got := Unpointer(tt.args.offset, tt.args.limit); !reflect.DeepEqual(got, tt.want) {
                t.Errorf("Unpointer() = %v, want %v", got, tt.want)
            }
        })
    }
}
```



### TestMain 函数

有时候，我们在做测试的时候，可能会在测试之前做些准备工作，例如创建数据库连接等；在测试之后做些清理工作，例如关闭数据库连接、清理测试文件等。这时，我们可以在_test.go文件中添加TestMain函数，其入参为*testing.M。

```go
func TestMain(m *testing.M) {
    fmt.Println("do some setup")
    m.Run()
    fmt.Println("do some cleanup")
}
```

### 测试覆盖率

生成测试覆盖率数据

```bash
$ go test -coverprofile=coverage.out
```

分析覆盖率文件

```bash
$ go tool cover -func=coverage.out
testwalle/main.go:14:   main            0.0%
testwalle/main.go:34:   Abc             100.0%
testwalle/main.go:38:   Def             100.0%
total:                  (statements)    22.2%
```

我们还可以使用go tool cover -html生成HTML格式的分析文件

```bash
$ go tool cover -html=coverage.out -o coverage.html
```

