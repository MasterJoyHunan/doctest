### 加载配置文件

```java
@PropertySource("classpath:application.properties") // 加载配置文件
@EnableConfigurationProperties({WebMvcProperties.class, ServerProperties.class})
public class WebConfig {}
```

### DispatchServlet 初始化

* 初始化解析器
* 初始化本地信息（i18n）
* 初始化主题解析
* 初始化路径映射 （重点）
* 初始化适配不同形式的控制器 （重点）
* 初始化异常解析 （重点）
* ......

### RequestMappingHandlerMapping 的作用

主要作用就是解析 @RequestMapping 和其派生注解与控制器之间的关系

```java
// 创建 RequestMappingHandlerMapping (请求路径映射对应的控制器之间的映射)
// 虽然有默认实现，但是该实现不在容器中
// 主要作用就是解析 @RequestMapping 和其派生注解与控制器之间的关系
@Bean
public RequestMappingHandlerMapping requestMappingHandlerMapping() {
		return new RequestMappingHandlerMapping();
}
```

使用

```java
public class TomcatApplication2 {

    public static void main(String[] args) throws Exception {
        AnnotationConfigServletWebServerApplicationContext context = new AnnotationConfigServletWebServerApplicationContext(WebConfig.class);
        RequestMappingHandlerMapping bean = context.getBean(RequestMappingHandlerMapping.class);
      	
      	// HandlerMethod 需要着重关注
        Map<RequestMappingInfo, HandlerMethod> handlerMethods = bean.getHandlerMethods();
        handlerMethods.forEach((k, v) -> {
            System.out.println(k + " => " + v);
        });

        // HandlerExecutionChain 需要着重关注
        HandlerExecutionChain chain = bean.getHandler(new MockHttpServletRequest("POST", "/test"));
        System.out.println(chain);
    }
}

```

### RequestMappingHandlerAdapter 处理器适配器

作用就是调用控制器方法

#### HandlerMethodArgumentResolver 参数解析器

如果想实现自定义参数解析器，需要实现 HandlerMethodArgumentResolver 接口

```java
@Target({ElementType.PARAMETER})
@Retention(RetentionPolicy.RUNTIME)
public @interface Token {}
```

```java
public class TokenParameterResolver implements HandlerMethodArgumentResolver {

    @Override
    public boolean supportsParameter(MethodParameter methodParameter) {
        return methodParameter.hasParameterAnnotation(Token.class);
    }

    @Override
    public Object resolveArgument(MethodParameter methodParameter, ModelAndViewContainer modelAndViewContainer, NativeWebRequest nativeWebRequest, WebDataBinderFactory webDataBinderFactory) throws Exception {
        return nativeWebRequest.getParameter("token");
    }
}
```

在控制器中使用

```java
@GetMapping("/token")
public String token(@Token String t) {
  	System.out.println("get token = " + t);
	  return t;
}
```

#### HandlerMethodReturnValueHandlerv返回值解析器

```java
@Target({ElementType.METHOD})
@Retention(RetentionPolicy.RUNTIME)
public @interface Yaml {
}
```

```java
public class YamlReturnHandler implements HandlerMethodReturnValueHandler {
    @Override
    public boolean supportsReturnType(MethodParameter returnType) {
        return returnType.hasMethodAnnotation(Yaml.class);
    }

    @Override
    public void handleReturnValue(Object returnValue, // 方法的返回值
                                  MethodParameter returnType, // 方法参数
                                  ModelAndViewContainer mavContainer,  // mvc 容器
                                  NativeWebRequest webRequest // req,resp 对象
    ) throws Exception {
        User user = (User) returnValue;

        // 输出响应
        HttpServletResponse response = webRequest.getNativeResponse(HttpServletResponse.class);
        response.setContentType("text/plain;charset=utf-8");
        response.getWriter().print("name:" + user.getName() + "\n" + "age:" + user.getAge());

        // 告诉MVC容器已经处理完毕
        mavContainer.setRequestHandled(true);
    }
}
```

在控制器中使用

```java
@GetMapping("/yaml")
@Yaml
public User yaml() {
    User bobo = new User("bobo", 1);
    System.out.println(bobo);
    return bobo;
}
```

#### 注册到 RequestMappingHandlerAdapter

```java
@Bean
public RequestMappingHandlerAdapter requestMappingHandlerAdapter() {
    List<HandlerMethodArgumentResolver> reqList = new ArrayList<>();
    List<HandlerMethodReturnValueHandler> respList = new ArrayList<>();

    reqList.add(new TokenParameterResolver()); // 参数解析器
    respList.add(new YamlReturnHandler()); // 返回值解析器
    RequestMappingHandlerAdapter adapter = new RequestMappingHandlerAdapter();
    adapter.setCustomArgumentResolvers(reqList);
    adapter.setCustomReturnValueHandlers(respList);
    return adapter;
}
```

### 常用的参数解析器

### Spring MVC 的执行流程

#### DispatcherServlet 初始化

#### DispatcherServlet 执行

1. 浏览器发送一个请求至DispatcherServlet
2. DispatcherServlet 根据请求到 RequestMappingHandlerMapping, 找到对应的 HandlerMethod 并且加上拦截器,返回 HandlerExecutionChain
3. DispatcherServlet  通过  RequestMappingHandlerAdapter(处理器适配器) 调用 HandlerExecutionChain
   1. 参数解析
   1. 参数类型装换
   1. 参数校验
   2. 数据绑定
   2. 返回值处理
   2. 最后返回 ModelAndView
4. DispatcherServlet 使用 ViewResolve 解析 ModelAndView
5. 渲染view
