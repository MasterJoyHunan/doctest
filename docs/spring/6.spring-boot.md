### Spring-boot 初始化

1. 获取 bean definition 配置源 

    ```JAVA
    // Some.class 是 bean definition 配置源
    SpringApplication application = new SpringApplication(Some.class);
      
    // 添加其他配置源
    HashSet<Object> objects = new HashSet<>();
    objects.add("classpath:bean.xml");
    application.setSources(new HashSet<>());
    ```

2. 判断是什么应用 Web/Reactive/非Web

3. 添加 ApplicationContext 初始化器

    ```java
     application.addInitializers(new ApplicationContextInitializer<ConfigurableApplicationContext>() {
       @Override
       public void initialize(ConfigurableApplicationContext applicationContext) {
         System.out.println("可以对 applicationContext 做点什么");
       }
     });
    ```

4. 注册监听器

    ```java
    spring.addListeners(new ApplicationListener<ApplicationEvent>() {
      @Override
      public void onApplicationEvent(ApplicationEvent event) {
    		System.out.println("可以监听spring提供的发布事件");
      }
    });
    ```

5. 推断主启动类

### Spring-boot run

1. 获取事件发布器发布事件
    1. starting 事件 -- 容器刚开始启动
    2. environmentPrepared -- 环境信息准备完成
    3. contextPrepared -- spring 容器创建完成，并初始化
    4. contextLoaded -- 加载完所有的 bean definition 
    5. started -- spring 容器初始化完成 （refresh 完成）
    6. running -- spring-boot 启动完毕
    7. failed -- spring-boot 启动失
2. 包装 args 参数
3. 准备环境变量 -- 加载配置文件,系统的环境变量,启动容器使用的参数
4. 将不规范的环境变量,转换为规范的环境变量
5. 将 spring.main 相关的环境变量绑定到 SpringApplication 对象
6. 打印 banner 信息 (启动时出现 springboot 的输出)
7. 创建 spring 容器 (web 还是非web 容器)
8. 回调 初始化器 (构造 SpringApplication 使用的 ApplicationContextInitializer)
9. 获取所有的 beanDefinition 源, 加载到容器
10. 调用 refresh() 方法 
11. 回调实现了 ApplicationRunner, CommandLineRunner 的方法

### refresh() 做了什么

1. `prepareRefresh()`将 spring 容器设置为激活状态
2. `obtainFreshBeanFactory()` 创建一个 beanFactory
3. `prepareBeanFactory(beanFactory)` beanFactory 进行准备工作
   1. 设置类加载器
   2. 设置表达式的解析器
   3. 注册一些 beanPostProcessor 
   4. 注册一些 bean
4. `postProcessBeanFactory(beanFactory)` beanFactory准备工作完成后进行的后置处理工作 (空实现)
5. `invokeBeanFactoryPostProcessors(beanFactory)` 执行 beanFactoryPostProcessors 的处理逻辑
   1. 包含 `BeanFactoryPostProcessor::postProcessBeanFactory() `
   1. 和 `BeanDefinitionRegistryPostProcessor::postProcessBeanDefinitionRegistry()`
6. `registerBeanPostProcessors(beanFactory)` 注册 BeanPostProcessors (重点)
7. `initMessageSource()` 初始化 i18n 组件
8. `initApplicationEventMulticaster()` 初始化事件发布器
9. `onRefresh()` 准备好各种组件后,调用(空实现)
10. `registerListeners()` 注册监听器
11. `finishBeanFactoryInitialization(beanFactory)`  初始化所有的单实例 bean (重点)
    1. bean 的生命周期

12. `finishRefresh()` 完成 IOC 容器的创建

### Bean 的生命周期

1. bean定义
1. bean注册
1. 实例化
1. 依赖注入
1. 初始化
1. 销毁

